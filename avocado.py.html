
# coding: utf-8

# In[1]:


#upload the packages

import pandas as pd
import numpy as np
import scipy.stats as stats
from scipy.stats import chi2

avocado = pd.read_csv('/Users/Michela/Documents/Kaggle/avocado.csv')

#Disclaimer: The data are not mine - taken from https://www.kaggle.com/neuromusic/avocado-prices

#Data description: 
#This data was downloaded from the Hass Avocado Board website in May of 2018 & compiled into a single CSV. Here's how the Hass Avocado Board describes the data on their website:

#> The table below represents weekly 2018 retail scan data for National retail volume (units) and price. Retail scan data comes directly from retailers’ cash registers based on actual retail sales of Hass avocados. Starting in 2013, the table below reflects an expanded, multi-outlet retail data set. Multi-outlet reporting includes an aggregation of the following channels: grocery, mass, club, drug, dollar and military. The Average Price (of avocados) in the table reflects a per unit (per avocado) cost, even when multiple units (avocados) are sold in bags. The Product Lookup codes (PLU’s) in the table are only for Hass avocados. Other varieties of avocados (e.g. greenskins) are not included in this table.

#Some relevant columns in the dataset:

#Date - The date of the observation
#AveragePrice - the average price of a single avocado
#type - conventional or organic
#year - the year
#Region - the city or region of the observation
#Total Volume - Total number of avocados sold
#4046 - Total number of avocados with PLU 4046 sold
#4225 - Total number of avocados with PLU 4225 sold
#4770 - Total number of avocados with PLU 4770 sold
#Acknowledgements

#Many thanks to the Hass Avocado Board for sharing this data!!

#http://www.hassavocadoboard.com/retail/volume-and-price-data



# In[2]:


#look at the data
avocado.head()
#Unnamed: 0 and Date are not imperative - we can drop them 


# In[3]:


avocado = avocado.drop(['Unnamed: 0', 'Date'], axis=1)


# In[5]:


#the downstream variable is the price. Lets look at the distribution for price. 

import matplotlib.pyplot as plt

avocado['AveragePrice'].hist()


# In[6]:


#there are organic and convential avocados - lets compare the distribution of the other variables 

avocado.groupby('type').hist(figsize=(20,10))
plt.show()


# In[7]:


#Check for NA values
avocado.isnull().sum()
#there are no NA values


# In[12]:


#describe the int64 columns
avocado.describe()


# In[ ]:


#results: organic corresponds to a higher price than conventional
#do a LRT for the different regions


# In[13]:


#distribution of the regions

pd.value_counts(avocado['region']).plot(kind="bar")
#there is an even number of regions


# In[15]:


#Q: Is there a difference between avocado prices? 
#to answer, we will perform a LRT 
#using mixed models are accounts for potential outliers

import statsmodels.api as sm
import statsmodels.formula.api as smf

model2 = smf.mixedlm(formula="AveragePrice ~ region", groups = avocado['region'], data=avocado).fit()

import warnings
warnings.filterwarnings('ignore') #there is a convergence warning, we ignore this 

print(model2.summary())



# In[16]:


#intercept only model - the null model 

model1 = smf.ols(formula="AveragePrice ~ 1", groups = avocado['region'], data=avocado).fit()

print(model1.summary())


# 
# def lrt(null, alt):
#     return(2*(null-alt))
# 
# LR=lrt(-9294,-7614) 
# stats.chi2.pdf(LR, 1)
# 

# In[20]:


#formulate the LRT 

def lrt(null, alt):
    return(2*(null-alt))

LR=lrt(-9294,-7776.0681 ) 
print("The p-value for the LRT between the region mixed model and the intercept-only model is "  + str(stats.chi2.pdf(LR, 1)))



#there is a statistical difference between the region and non-region models 
#suggesting that region does contribute to the price


# In[22]:


#next - is there a difference between the regions and covariates and region-only model? 

#change column names so all are one word
avocado = avocado.rename(columns={'Total Volume': 'Volume','Total Bags': 'TotalBags', 'Small Bags': 'SmallBags', 'Large Bags' : 'LargeBags', 'XLarge Bags' : 'XLargeBags'})

model3 = smf.mixedlm(formula="AveragePrice ~ region + type + Volume + year + TotalBags + SmallBags + LargeBags + XLargeBags", groups = avocado['region'], data=avocado).fit()

print(model3.summary())


# In[23]:


LR2=lrt( -7776.0681, -2105.8988 ) 
print("The p-value for the LRT between the region mixed model and the region+covariates mixed model is "  + str(stats.chi2.pdf(LR2, 1)))




# In[24]:


#for a random forest, we need to create dummy variables for strings 

organic_conv = pd.get_dummies(avocado['type'])
region = pd.get_dummies(avocado['region'])
avocado = avocado.join(organic_conv)
avocado = avocado.join(region)
#remove the string columns
avocado = avocado.drop('region', axis=1)
avocado = avocado.drop('type', axis=1)
print(avocado.shape)
list(avocado)


# In[25]:


#now we change the data type to array 
y = np.array(avocado['AveragePrice'])
x = avocado.drop('AveragePrice', axis=1)
x_names = list(x.columns)
#print(x_names)
x = np.array(x)


# In[26]:


#now we split the data into training and testing sets

from sklearn.model_selection import train_test_split
train_features, test_features, train_labels, test_labels = train_test_split(x, y, test_size = 0.25)

#25% of the data is testing data, while we are training on 75%

print('Training Features Shape:', train_features.shape)
print('Training Labels Shape:', train_labels.shape)
print('Testing Features Shape:', test_features.shape)
print('Testing Labels Shape:', test_labels.shape)


# In[33]:


# Import the model we are using
from sklearn.ensemble import RandomForestRegressor
# Instantiate model with 1000 decision trees
rf = RandomForestRegressor(n_estimators = 10, random_state = 42)
# Train the model on training data
rf.fit(train_features, train_labels);


# In[34]:


#predict on the test set

predictions = rf.predict(test_features)


errors = abs(predictions - test_labels)
# Print out the mean absolute error (mae)
print('Mean Absolute Error:', round(np.mean(errors), 2) ,'$')


# In[35]:


mape = 100 * (errors / test_labels)
# Calculate and display accuracy
accuracy = 100 - np.mean(mape)
print('Accuracy:', round(accuracy, 2), '%.')


# In[36]:


from sklearn.tree import export_graphviz
import pydot
# Extract the small tree
tree = rf.estimators_[5]
# Save the tree as a png image
export_graphviz(tree, out_file = 'tree.dot', feature_names = x_names, rounded = True, precision = 1)
(graph, ) = pydot.graph_from_dot_file('tree.dot')
graph.write_png('tree.png');


# In[37]:


(graph, ) = pydot.graph_from_dot_file('tree.dot')


# In[40]:


from IPython.display import Image
Image(filename='/Users/Michela/small_tree.png') 


# In[239]:


#results - seems the largest predictor is conventional or not. 
#If conventional, larger bags correspond to a lager cost, suggesitn individuals buy in bulk
#the only region on the sample tree is from HartfordSpringfield, in Connecticut. 
#If an avocado in a large bag is from this region, corresponds to lower prices. 
#If an avocado is organic, the PLU 4046 is the next node. 

